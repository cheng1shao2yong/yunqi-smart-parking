<template>
    <div ref="pageContainer" class="page-contaier" :style="fullScreen?'padding:15px;':''">
        <el-row>
            <el-col :md="18" :xs="24">
                <el-row v-if="screen.length>0">
                    <el-col :span="screen.length>1?12:24" v-for="(item,index) in screen">
                        <el-card shadow="hover" body-style="padding:0">
                            <div class="screen" :style="`height:${girdheight}px;`">
                                <div class="screen-top">
                                    <div class="title">{{item.title}}</div>
                                </div>
                                <template v-if="item.url">
                                    <div class="zhuji">
                                        <div style="width:100%;" :id="`video-${item.id}`"></div>
                                        <div class="fuji" :style="fuji.expand?`width:100%;left:0;top:0;z-index:999;`:`width:30%;height:${girdheight/3.5}px;left:${30*findex}%`" v-for="(fuji,findex) in item.fuji">
                                            <div class="title">
                                                è¾…æœº
                                                <i @click="fuji.expand=!fuji.expand" :class="fuji.expand?'fa fa-compress':'fa fa-expand'"></i>
                                            </div>
                                            <div style="width:100%;" :id="`video-${fuji.id}`"></div>
                                        </div>
                                    </div>
                                </template>
                                <div class="error" v-else><i class="fa fa-remove"></i>&nbsp;è·å–è§†é¢‘åœ°å€å¤±è´¥</div>
                                <div class="btn-group">
                                    <el-button @click="photo(item)" type="primary">æ‹ç…§</el-button>
                                    <el-button @click="trigger(item)" type="warning">è¯†åˆ«</el-button>
                                    <el-button @click="open(item)" type="danger">å¼€é—¸</el-button>
                                    <el-button @click="close(item)" type="info">å…³é—¸</el-button>
                                </div>
                            </div>
                        </el-card>
                    </el-col>
                </el-row>
                <el-row v-else>
                    <el-col :span="24">
                        <el-card shadow="hover">
                            <div @click="drawer.show=true" class="barrier" :style="`height:${girdheight}px;`"><i class="fa fa-plus"></i>&nbsp;æ·»åŠ é€šé“ç›‘æ§</div>
                        </el-card>
                    </el-col>
                </el-row>
            </el-col>
            <el-col :md="6" :xs="24">
                <div style="width:100%;padding-left: 10px">
                    <el-card shadow="never">
                        <template #header>
                            <div class="log-title">é€šé“å³æ—¶æ¶ˆæ¯</div>
                        </template>
                        <div class="log-container" :style="`height:${logheight}px;`">
                            <el-scrollbar>
                            <template v-for="i in log.length">
                                <div v-html="log[log.length-i].message" class="log-item" :style="`color:${log[log.length-i].color}`"></div>
                            </template>
                            <div class="nodata" v-if="log.length===0">ğŸ˜¢æš‚æ— æ¶ˆæ¯ï¼</div>
                            </el-scrollbar>
                        </div>
                    </el-card>
                    <el-card shadow="never" style="margin-top:10px;">
                        <div style="display: flex;justify-content: space-between;">
                            <el-button @click="drawer.show=true" type="primary" style="width: 30%"><i class="fa fa-cogs"></i>&nbsp;è®¾ç½®é€šé“</el-button>
                            <el-button v-if="fullScreen" @click="disfullscreen" type="success" style="width: 30%"><i class="fa fa-compress"></i>&nbsp;å–æ¶ˆå…¨å±</el-button>
                            <el-button v-else @click="fullscreen" type="success" style="width: 30%"><i class="fa fa-expand"></i>&nbsp;å…¨å±å±•ç¤º</el-button>
                            <el-button @click="clearCache" type="warning" style="width: 30%"><i class="fa fa-trash"></i>&nbsp;æ¸…é™¤è®°å½•</el-button>
                        </div>
                    </el-card>
                </div>
            </el-col>
        </el-row>
    </div>
    <el-dialog width="800" v-model="drawer.show" size="40%">
        <template #header>
            <div style="font-size: 18px;font-weight: bold;"><i class="fa fa-plus"></i>&nbsp;æ·»åŠ é€šé“ç›‘æ§</div>
        </template>
        <template #default>
            <yun-form ref="yunform" :columns="columns">
                <template #tips>
                    <el-form-item label="">
                        <el-alert :closable="false" type="warning" show-icon title="1ã€ä½¿ç”¨æœ¬åœ°è§†é¢‘æ›´åŠ æ¸…æ™°ã€‚2ã€ä½¿ç”¨äº‘è§†é¢‘æ—¶ï¼Œç®¡ç†äººå‘˜é•¿æ—¶é—´æ— ä»»ä½•æ“ä½œï¼Œç›‘æ§å°†è‡ªåŠ¨åœæ­¢ã€‚"></el-alert>
                    </el-form-item>
                </template>
                <template #footer>
                    <el-button @click="confirm" type="primary">æäº¤</el-button>
                    <el-button @click="drawer.show=false">å–æ¶ˆ</el-button>
                </template>
            </yun-form>
        </template>
    </el-dialog>
</template>
<script>
    let jessibuca;
    let mqtt;
    let mouseX,mouseY,flvPlayer=[],ispause=false,changetime=0;
    import form from "@components/Form.js";
    export default {
        components: {
            'YunForm': form
        },
        data:{
            screen:Yunqi.data.screen,
            fullScreen:false,
            drawer:{
                show:false
            },
            girdheight:0,
            logheight:0,
            columns: [
                {field: "barrier_id", title: "é€‰æ‹©é€šé“", edit: {form:'select',multiple:true,value:Yunqi.data.screen.map(res=>{return res.id;})}, searchList:Yunqi.data.barrier,rules: "required;length(1~4)"},
            ],
            log:[]
        },
        onLoad(){
            Yunqi.use(['/assets/js/jessibuca/jessibuca.js','/assets/js/mqtt.min.js']).then(res=>{
                jessibuca=res.Jessibuca;
                mqtt=res.mqtt;
                this.connectMqtt();
            });
        },
        onShow(e){
            let containerHeight=this.$refs.pageContainer.clientHeight;
            if(parent==window){
                this.fullScreen=true;
                if(this.screen.length>1){
                    this.girdheight=(containerHeight-34)/2;
                }else{
                    this.girdheight=containerHeight-34;
                }
                this.logheight=containerHeight-218;
            }else{
                if(this.screen.length>1){
                    this.girdheight=(containerHeight)/2;
                }else{
                    this.girdheight=containerHeight;
                }
                this.logheight=containerHeight-180;
            }
            document.addEventListener('mousemove', function(event) {
                if(mouseX!=event.clientX || mouseY!=event.clientY){
                    mouseX = event.clientX;
                    mouseY = event.clientY;
                    changetime=0;
                    return;
                }
            });
            if(Yunqi.data.screen.length>0){
                let that=this;
                setTimeout(()=>{
                    if(top!=window){
                        let title=top.Yunqi.app.activeMenu.title;
                        if(title=='é€šé“ç›‘æ§'){
                            that.playscreen();
                        }
                    }else{
                        that.playscreen();
                    }
                },1500);
                setInterval(()=>{
                    if(changetime>600){
                        for(let i=0;i<flvPlayer.length;i++){
                            if(!ispause){
                                flvPlayer[i].pause();
                                console.log('è§†é¢‘å·²ç»æš‚åœ')
                            }
                        }
                        ispause=true;
                    }else{
                        for(let i=0;i<flvPlayer.length;i++){
                            if(ispause){
                                flvPlayer[i].play();
                                console.log('è§†é¢‘é‡æ–°å¼€å§‹')
                            }
                        }
                        ispause=false;
                    }
                    changetime++;
                },1000);
            }
        },
        methods: {
            playscreen:function (){
                for(let i=0;i<Yunqi.data.screen.length;i++){
                    this.play(Yunqi.data.screen[i]);
                    if(Yunqi.data.screen[i].fuji.length>0){
                        for(let j=0;j<Yunqi.data.screen[i].fuji.length;j++){
                            this.play(Yunqi.data.screen[i].fuji[j]);
                        }
                    }
                }
            },
            connectMqtt:function (){
                let config=Yunqi.data.mqtt;
                let options={
                    clean: true,
                    connectTimeout: 4000,
                    reconnectPeriod: 1000,
                    clientId:Yunqi.data.clientId,
                    username:config.mqtt_username,
                    password:config.mqtt_password
                };
                let client = mqtt.connect('wss://'+config.mqtt_host+':'+config.mqtt_web_port+'/mqtt', options);
                let topic=[];
                for(let i=0;i<this.screen.length;i++){
                    topic.push(this.screen[i].serialno+'/barrier/screen/record/message/'+this.screen[i].parking_id);
                }
                client.on('connect', () => {
                    client.subscribe(topic,() => {
                        console.log(`mqttè¿æ¥æˆåŠŸ`);
                    });
                });
                client.on('message', (topic, res) => {
                    res=JSON.parse(res.toString());
                    let body=res.payload.body;
                    if(body.type=="pay"){
                        let {color,message}=body;
                        this.log.push({color:color,message:message});
                    }
                    if(body.type=="message"){
                        this.log.push(body);
                    }
                });
            },
            play:function (screen){
                if(!screen.url){
                    return;
                }
                try{
                    let showOperateBtns=false;
                    let forceNoOffscreen=true;
                    let container=document.getElementById('video-'+screen.id);
                    let jess = new jessibuca({
                        container: container,
                        videoBuffer: 0.2, // ç¼“å­˜æ—¶é•¿
                        isResize: false,
                        text: "",
                        decoder:'/assets/js/jessibuca/decoder.js',
                        loadingText: "åŠ è½½ä¸­",
                        debug: false,
                        showBandwidth: showOperateBtns, // æ˜¾ç¤ºç½‘é€Ÿ
                        operateBtns: {
                            fullscreen: showOperateBtns,
                            screenshot: showOperateBtns,
                            play: showOperateBtns,
                            audio: showOperateBtns,
                            record: showOperateBtns
                        },
                        useWCS: true,
                        wcsUseVideoRender:true,
                        forceNoOffscreen: forceNoOffscreen,
                        isNotMute: false,
                    });
                    flvPlayer.push(jess);
                    setTimeout(()=>{
                        jess.play(screen.url);
                    },200);
                }catch (e){
                    console.log(e);
                }
            },
            confirm:function (){
                let barrier_id=this.$refs.yunform.getValue('barrier_id');
                if(barrier_id.length===0){
                    Yunqi.message.error('è¯·é€‰æ‹©é€šé“');
                    return;
                }
                if(barrier_id.length>4){
                    Yunqi.message.error('æœ€å¤šé€‰æ‹©4ä¸ªé€šé“');
                    return
                }
                this.drawer.show=false;
                Yunqi.ajax.post('screen/add',{barrier_id}).then(res=>{
                    location.reload();
                });
            },
            fullscreen:function (){
                parent.location.href=Yunqi.config.baseUrl+'screen/index.html';
            },
            disfullscreen:function (){
                location.href=Yunqi.config.baseUrl+'screen/index.html?ref=addtabs';
            },
            clearCache:function (){
                this.log=[];
            },
            open:function (barrier){
                Yunqi.confirm('æ‚¨ç¡®å®šè¦æ‰“å¼€'+barrier.title+'å—ï¼Ÿ').then(res=>{
                    Yunqi.ajax.post('screen/open',{barrier_id:barrier.id});
                });
            },
            close:function (barrier){
                Yunqi.confirm('æ‚¨ç¡®å®šè¦å…³é—­'+barrier.title+'å—ï¼Ÿ').then(res=>{
                    Yunqi.ajax.post('screen/close',{barrier_id:barrier.id});
                });
            },
            photo:function (barrier){
                Yunqi.ajax.post('screen/photo',{barrier_id:barrier.id});
            },
            trigger:function (barrier){
                Yunqi.ajax.post('screen/trigger',{barrier_id:barrier.id});
            }
        }
    }
</script>
<style>
.page-contaier{
    background-color: var(--el-bg-color-page);
    position: fixed;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
}
.screen{
    position: relative;
}
.screen,.barrier{
    text-align: center;
    font-size: 16px;
    display: flex;
    justify-content: center;
    align-items: center;
}
.screen-top{
    position: absolute;
    top: 0px;
    left: 0;
    width: 100%;
    z-index: 3;
}
.screen-top .title{
    font-size: 16px;
    display: inline;
    background: rgba(0,0,0,0.3);
    color: #fff;
    padding: 5px 10px;
    border-radius: 4px;
}
.barrier{
    cursor: pointer;
}
.log-title{
    font-weight: bold;
    font-size: 16px;
}
.log-container{
    overflow-y: auto;
    font-size: 14px;
}
.log-item{
    font-size: 12px;
    margin-bottom: 5px;
}
.error{
    color: var(--el-color-error);
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
}
.nodata{
    color: grey;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
}
.btn-group{
    position: absolute;
    bottom: 5px;
    right: 10px;
    width: 260px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 2;
}
.zhuji{
    position: relative;
    width: 100%;
    height: 100%;
}
.fuji{
    background: rgba(255,255,255,0.8);
    position: absolute;
    bottom: 0px;
    left: 0px;
    z-index: 1;
}
.fuji .title{
    font-size: 12px;
    display: inline;
    background: rgba(0,0,0,0.3);
    color: #fff;
    padding: 3px 0px;
    position: absolute;
    text-align: center;
    width: 100%;
}
.fuji .title .fa{
    position: absolute;
    right: 5px;
    top: 7px;
    cursor: pointer;
    z-index: 9999;
}
</style>
